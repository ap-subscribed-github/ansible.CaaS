---
  - name: Deploy Dimension Data infrastructure  
    hosts: localhost
    vars:
      root_password: P$$ssWwrrdGoDd!
    vars_files:
      - /root/caas_credentials.yml
    tasks:
      - name: Deploy my Nework Domain
        caas_networkdomain:
          caas_credentials: "{{ caas_credentials }}"
          name: "ansible.CaaS_Sandbox"
        register: caas_networkdomain
#      - name: print debug
#        debug: var=caas_networkdomain
      - name: Deploy WebServers DMZ
        caas_vlan:
          caas_credentials: "{{ caas_credentials }}"
          networkDomainName: "{{ caas_networkdomain.networkdomains.networkDomain[0].name }}"
          name: "vlan_webservers"
          privateIpv4BaseAddress: "172.24.42.0"
        register: caas_vlan_webservers
      - name: Deploy WebServers
        caas_server:
          caas_credentials: "{{ caas_credentials }}"
          wait: False
          name: "WebServer"
          #state: "absent"
          #action: shutdownServer
          count: 3
          #description: ansible.CaaS This a test, feel free to delete
          #imageId: bfe177f0-23ec-4886-a046-c516f354fd53
          imageName: CentOS 7 64-bit 2 CPU
          administratorPassword: "{{ root_password }}"
          #cpu:
              #count: 16
              #coresPerSocket: 1
              #speed: STANDARD
          networkInfo:
              #networkDomainId: fd340f41-7f93-4dda-a7f2-e46cc6302613
              networkDomainName: "{{ caas_networkdomain.networkdomains.networkDomain[0].name }}"
              primaryNic: 
                  #vlanId: 0cd34569-e3b4-46ca-9c86-3e8c2b08d732
                  vlanName: vlan_webservers
                  #privateIpv4: 172.24.42.42
        register: caas_server
      - name: Disable Default Rule that Drop Any external IPv6 connection
        caas_firewallrule:
          caas_credentials: "{{ caas_credentials }}"
          networkDomainName: "{{ caas_networkdomain.networkdomains.networkDomain[0].name }}"
          name: "CCDEFAULT.DenyExternalInboundIPv6"
          enabled: False
      - name: Add FireWall Rule to allow IPv4 SSH for Ansible
        caas_firewallrule:
          caas_credentials: "{{ caas_credentials }}"
          networkDomainName: "{{ caas_networkdomain.networkdomains.networkDomain[0].name }}"
          name: "ssh_for_ansible"
          #action: "ACCEPT_DECISIVELY"
          #ipVersion: "IPV6"
          #protocol: "TCP"
          source:
            ip:
              address: 10.2.0.0
              prefixSize: 16
          destination:
            ip:
              address: 10.4.0.0
              prefixSize: 16
            port:
              begin: 22
          placement:
            position: "LAST"
          #enabled: False
      - name: Add FireWall Rule to allow IPv6 SSH for Ansible
        caas_firewallrule:
          caas_credentials: "{{ caas_credentials }}"
          networkDomainName: "{{ caas_networkdomain.networkdomains.networkDomain[0].name }}"
          name: "ssh_for_ansible_to_vlan_webservers"
          action: "ACCEPT_DECISIVELY"
          ipVersion: "IPV6"
          protocol: "TCP"
          source:
            ip:
              address: "{{ ansible_all_ipv6_addresses[0] }}"
          destination:
            ip:
              address: "{{ caas_vlan_webservers.vlans.vlan[0].ipv6Range.address }}"
              prefixSize: "{{ caas_vlan_webservers.vlans.vlan[0].ipv6Range.prefixSize }}"
            port:
              begin: 22
          placement:
            position: "LAST"
          #enabled: False
      - name: Get Public IPv4
        caas_publicip:
          caas_credentials: "{{ caas_credentials }}"
          networkDomainName: "{{ caas_networkdomain.networkdomains.networkDomain[0].name }}"
      - name: Add new instances to group WebServers
        add_host: name="{{ item.id }}" ansible_ssh_host="{{ item.networkInfo.primaryNic.ipv6 }}" ansible_ssh_pass="{{ root_password }}" groupname=WebServers
        when: item.started
        with_items: caas_server.servers.server
      - name: Wait for SSH to come up
        wait_for: host="{{ item.networkInfo.primaryNic.ipv6 }}" port=22 timeout=300 state=started
        when: item.started
        with_items: caas_server.servers.server
  - name: Configure Servers
    hosts: WebServers
    sudo: True
    gather_facts: True
    tasks:
      - name: ping
        ping:
      - name: Install latest Apache Web Server
        yum: name=httpd state=latest